  - name: Ensure resource group for bursting to Azure exist
    azure_rm_resourcegroup:
      name: "{{ groupPrefix }}-bursting"
      location: "{{ location }}"

  - name: Make sure bursting VNET exists
    azure_rm_virtualnetwork:
      name: "{{ groupPrefix }}-burstnet"
      resource_group: "{{ groupPrefix }}-bursting"
      address_prefixes_cidr:
      - "10.99.0.0/24"

  - name: Make sure bursting subnet exists
    azure_rm_subnet:
      name: "{{ groupPrefix }}-burstsub"
      virtual_network_name: "{{ groupPrefix }}-burstnet"
      resource_group: "{{ groupPrefix }}-bursting"
      address_prefix_cidr: "10.99.0.0/24"

  - name: Ensure web farm for bursting is deployed
    azure_rm_deployment:
      deployment_name: f5-bursting
      location: "{{ location }}"
      resource_group_name: "{{ groupPrefix }}-burst-web"
      template: "{{ lookup('file', 'webFarm.json') }}"
      parameters:
        instances: 
          value: 3
        vnetResourceGroupName:
          value: "{{ groupPrefix }}-bursting"
        vnetName:
          value: "{{ groupPrefix }}-burstnet"
        subnetName:
          value: "{{ groupPrefix }}-burstsub"
        vmSize:
          value: Standard_A1_v2
        F5pool:
          value: burst
        adminUsername:
          value: tomas
        adminPassword:
          value: Azure12345678

  - name: Ensure VM for F5 cloud proxy is deployed
    azure_rm_virtualmachine:
      resource_group: "{{ groupPrefix }}-burst-web"
      name: f5-cloud-proxy
      vm_size: Standard_A1_v2
      managed_disk_type: Standard_LRS
      admin_username: tomas
      admin_password: Azure12345678
      ssh_password_enabled: true
      virtual_network_name: "{{ groupPrefix }}-burstnet"
      subnet_name: "{{ groupPrefix }}-burstsub"
      image:
        offer: UbuntuServer
        publisher: Canonical
        sku: 16.04-LTS
        version: latest
      open_ports:
        - 22
        - 443